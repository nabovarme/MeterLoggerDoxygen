<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MeterLogger: MeterLogger</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MeterLogger
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">MeterLogger </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>MeterLogger is a custom daughterboard you can insert in Kamstrup Meters and get them to transmit their samples to a remote MQTT server. MeterLogger is part of the <a href="https://github.com/nabovarme"><b>Nabovarme</b></a> orgnaization.</p>
<p>Check out the <a href="https://github.com/nabovarme/MeterLogger/wiki">WIKI</a> for more details!</p>
<h2>Build details</h2>
<p>To build and flash for KMP type meter (Multical 601): </p><div class="fragment"><div class="line">KEY=ef500c9268cf749016d26d6cbfaaf7bf make clean all flashall  </div></div><!-- fragment --><p>To build and flash for en61107, sub type Multical 66 C: </p><div class="fragment"><div class="line">EN61107=1 KEY=ef500c9268cf749016d26d6cbfaaf7bf make clean all flashall  </div></div><!-- fragment --><p>To build and flash for en61107, sub type Multical 66 B: </p><div class="fragment"><div class="line">MC_66B=1 KEY=ef500c9268cf749016d26d6cbfaaf7bf make clean all flashall  </div></div><!-- fragment --><p>To build and flash for KMP/en61107 type, forced as flow meter: </p><div class="fragment"><div class="line">FLOW_METER=1 KEY=ef500c9268cf749016d26d6cbfaaf7bf make clean all flashall  </div></div><!-- fragment --><p>To build and flash for impulse based electricity meter: </p><div class="fragment"><div class="line">IMPULSE=1 KEY=ef500c9268cf749016d26d6cbfaaf7bf make clean all flashall  </div></div><!-- fragment --><p>To configure wireless network: </p><div class="fragment"><div class="line">SERIAL=9999999 KEY=ef500c9268cf749016d26d6cbfaaf7bf make wifisetup  </div></div><!-- fragment --><p><b>BUILD OPTIONS</b> DEBUG=1 enable serial debugging</p>
<p>DEBUG_NO_METER=1 dont wait for meter to answer</p>
<p>DEBUG_SHORT_WEB_CONFIG_TIME=1 dont wait for web config</p>
<p>IMPULSE=1 meter type is impulse based (100 mS)</p>
<p>EN61107=0 meter type is KMP (Multical 601)</p>
<p>EN61107=1 meter type is en61107, sub type Multical 66 C</p>
<p>MC_66B=1 meter type is en61107, sub type Multical 66 B</p>
<p>FLOW_METER=1 meter is forced to run as a flow meter and close when volume is reached</p>
<p>AUTO_CLOSE=1 automatically check if energy is larger than the value set by open_until mqtt command</p>
<p>DEBUG_STACK_TRACE=1 Enable exception stack trace dump at to flash at address STACK_TRACE_SEC * SPI_FLASH_SEC_SIZE (0x80000), STACK_TRACE_N bytes</p>
<p>NO_CRON=1 disable cron stuff and save 2688 bytes of RAM. Reconfiguration is needed after changing this</p>
<p>THERMO_NO=0 thermo actuator is normal closed</p>
<p>THERMO_NO=1 thermo actuator is normal open</p>
<p>THERMO_ON_AC_2 thermo actuator connected on ac 2</p>
<p>LED_ON_AC=1 use led to indicate ac state</p>
<p>SERIAL=9999999 serial number for meter used for device's SSID: IMPULSE meters EL_9999999 and other Kamstrup meters KAM_9999999. Used in make wifisetup target and if DEBUG_NO_METER=1</p>
<p>KEY=ef500c9268cf749016d26d6cbfaaf7bf master key for crypto, 16 bytes First 8 bytes hex encoded (ef500c9268cf7490) is wifi setup password. Master key is sha256 hashed to 32 bit and first 16 bytes is aes key and last 16 bytes is hmac sha256 key.</p>
<div class="fragment"><div class="line">master key                            wifi key (first 16 bytes)</div><div class="line">+--------------------------------+    +----------------+</div><div class="line">|ef500c9268cf749016d26d6cbfaaf7bf| -&gt; |ef500c9268cf7490| </div><div class="line">+--------------------------------+    +----------------+</div><div class="line">                |</div><div class="line">          [sha256 hash]</div><div class="line">                |</div><div class="line">                v</div><div class="line">+----------------------------------------------------------------+</div><div class="line">|89a5d4f82ad86bc9ec27427e246fd15481663afea8c463d93cc93c967c9b31be|</div><div class="line">+----------------------------------------------------------------+</div><div class="line">                |                                        |</div><div class="line">aes key         v                   hmac sha256 key      v</div><div class="line">+--------------------------------+  +--------------------------------+</div><div class="line">|89a5d4f82ad86bc9ec27427e246fd154|  |81663afea8c463d93cc93c967c9b31be|</div><div class="line">+--------------------------------+  +--------------------------------+</div></div><!-- fragment --><p>Crypto is applies on mqtt packages like this: 1) at 32 bytes offset in <a class="el" href="structmqtt__message.html">mqtt_message</a> contains IV, 16 bytes random bytes used for AES128 CBC encryption.</p>
<p>2) cleartext (0-terminated) is AES128 CBC encrypted, with aes key and IV. Result is written to <a class="el" href="structmqtt__message.html">mqtt_message</a> at 32 + 16 bytes offset (binary data not 0-terminated).</p>
<p>3) HMAC SHA256 checksum is calculated on topic + IV + encrypted data and written to first 32 bytes.</p>
<div class="fragment"><div class="line">hmac sha256                                                       IV                               encrypted data</div><div class="line">+----------------------------------------------------------------+--------------------------------+------------------------------------+</div><div class="line">|b218d7ec2f7977c942b5bf16d535de3cb5f0e012638148e5a7fc6e09efe440a7|54cd3d04f024e7e5c4876248cc146c41|9616bb291182861b7a5ea238a0c267115...|</div><div class="line">+--------------------------------------------------------------------------------------------------------------------------------------+</div><div class="line"></div><div class="line"></div><div class="line">IV</div><div class="line">+--------------------------------+</div><div class="line">|54cd3d04f024e7e5c4876248cc146c41| </div><div class="line">+--------------------------------+</div><div class="line"></div><div class="line">cleartext message (null terminated)</div><div class="line">+-----------------------------------------------------------------------------------------------------------------+</div><div class="line">|heap=21376&amp;t1=23.61 C&amp;t2=22.19 C&amp;tdif=1.42 K&amp;flow1=0 l/h&amp;effect1=0.0 kW&amp;hr=73327 h&amp;v1=1321.27 m3&amp;e1=56.726 MWh&amp;\0|</div><div class="line">+-----------------------------------------------------------------------------------------------------------------+</div><div class="line"></div><div class="line">+</div><div class="line"></div><div class="line">hmac sha256 key</div></div><!-- fragment --><p><b>MQTT format for messages sent <em>to</em> meter</b></p>
<table class="doxtable">
<tr>
<th align="left">Topic </th><th align="left">Message  </th></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/ping </td><td align="left"></td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/open </td><td align="left">[unix time] </td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/open_until </td><td align="left">[kWh when meter should close (only write to flash if changed and not negative value)] </td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/open_until_delta </td><td align="left">[[kWh when meter should close as delta (only write to flash if changed and not negative value)] </td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/close </td><td align="left">[unix time] </td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/status </td><td align="left"></td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/set_cron </td><td align="left">minute=30&amp;hour=*&amp;day_of_month=*&amp;month=*&amp;day_of_week=*&amp;command=open </td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/set_cron </td><td align="left">minute=30&amp;hour=*&amp;day_of_month=*&amp;month=*&amp;day_of_week=*&amp;command=close </td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/set_cron </td><td align="left">minute=30&amp;hour=*&amp;day_of_month=*&amp;month=*&amp;day_of_week=*&amp;command=set_ssid_pwd=ssid=the_ssid&amp;pwd=secret </td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/set_cron </td><td align="left">minute=30&amp;hour=*&amp;day_of_month=*&amp;month=*&amp;day_of_week=*&amp;command=clear_cron </td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/cron </td><td align="left"></td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/clear_cron </td><td align="left">[unix time] </td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/ping </td><td align="left"></td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/version </td><td align="left"></td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/uptime </td><td align="left"></td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/stack_trace </td><td align="left">[enable stack trace dumps until restart i.e. once (only if built with DEBUG_STACK_TRACE=1)] </td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/vdd </td><td align="left"></td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/rssi </td><td align="left"></td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/ssid </td><td align="left"></td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/scan </td><td align="left"></td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/set_ssid </td><td align="left">[ssid] </td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/set_pwd </td><td align="left">[pwd] </td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/set_ssid_pwd </td><td align="left">[ssid=name&amp;pwd=secret] </td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/wifi_status </td><td align="left"></td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/start_ap </td><td align="left">[start ap + save to flash if changed] </td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/stop_ap </td><td align="left">[stop ap + save to flash if changed] </td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/ap_status </td><td align="left"></td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/reconnect </td><td align="left"></td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/save (only pulse meter) </td><td align="left"></td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/mem </td><td align="left"></td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/reset_reason </td><td align="left"></td></tr>
<tr>
<td align="left">/config/v2/9999999/[unix time]/restart </td><td align="left"></td></tr>
</table>
<p><b>MQTT format for messages sent <em>from</em> meter</b></p>
<table class="doxtable">
<tr>
<th align="left">Topic </th><th align="left">Message  </th></tr>
<tr>
<td align="left">/sample/v2/9999999/[unix time] </td><td align="left">heap=20000&amp;t1=25.00 C&amp;t2=15.00 C&amp;tdif=10.00 K&amp;flow1=0 l/h&amp;effect1=0.0 kW&amp;hr=0 h&amp;v1=0.00 m3&amp;e1=0 kWh&amp; </td></tr>
<tr>
<td align="left">/cron/v2/9999999/[unix time] </td><td align="left">12 </td></tr>
<tr>
<td align="left">/ping/v2/9999999/[unix time] </td><td align="left"></td></tr>
<tr>
<td align="left">/version/v2/9999999/[unix time] </td><td align="left">[sdk version]-[git version] </td></tr>
</table>
<p>| /status/v2/9999999/[unix time] | [open|close] | | /open_until/v2/9999999/[unix time] | [kWh when meter should close] | | /open_until_delta/v2/9999999/[unix time] | [kWh when meter should close] | | /uptime/v2/9999999/[unix time] | [uptime in seconds] | | /stack_trace/v2/9999999/[unix time] | | | /vdd/v2/9999999/[unix time] | [power supply voltage level] | | /rssi/v2/9999999/[unix time] | [rssi of the wifi it is connected to (in dBm, 31 if fail)] | | /ssid/v2/9999999/[unix time] | [ssid of the wifi it is connected to] | | /set_ssid/v2/9999999/[unix time] | [ssid of the wifi it is set to connect to] | | /set_pwd/v2/9999999/[unix time] | [password for the wifi it is set to connect to] | | /set_ssid_pwd/v2/9999999/[unix time] | [combined ssid and password for the wifi it is set to connect to] | | /scan_result/v2/9999999/[unix time] | [ssid=Loppen Public&amp;rssi=-51&amp;channel=11] | | /wifi_status/v2/9999999/[unix time] | [connected or disconnected] | | /ap_status/v2/9999999/[unix time] | [started or stopped] | | /save/v2/9999999/[unix time] (only pulse meter) | saved | | /mem/v2/9999999/[unix time] | heap=9672 | | /reset_reason/v2/9999999/[unix time] | | </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
